<!DOCTYPE html>
<html>
<head>
    <title>Account</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
<main>
    <h1>Account</h1>

    <a href="prices.html">Add a subscription</a>
    <a href="register.html">Restart demo</a>

    <h2>Subscriptions</h2>

    <div id="subscriptions">
        <!-- see account.js to see how this div is populated -->
    </div>
</main>

<script>
    document.addEventListener('DOMContentLoaded', async () => {
        // Fetch the list of subscriptions for this customer.
        const response = await fetch('/api/stripe/subscriptions').then((r) => r.json());

        // Construct and display each subscription, its status, last4 of the card
        // used, and the current period end.
        const subscriptionsDiv = document.querySelector('#subscriptions');
        subscriptionsDiv.innerHTML = response.data.map((subscription) => {
            let last4 = subscription.default_payment_method?.card?.last4 || '';
            return `
      <hr>
      <h4>
        ${subscription.id}
      </h4>

      <p>
        Status: ${subscription.status}
      </p>

      <p>
        Card last4: ${last4}
      </p>
      <small>If the last4 is blank, ensure webhooks are being handled. The default payment method is set in the webhook handler.</small>

      <p>
        Current period end: ${new Date(subscription.current_period_end * 1000)}
      </p>

      <!--<a href="change-payment-method.html?subscription=${subscription.id}"> Update payment method </a><br />
      <a href="change-plan.html?subscription=${subscription.id}"> Change plan </a><br /> -->
      <a href="cancel.html?subscription=${subscription.id}"> Cancel </a><br />
    `;
        }).join('<br />');
    });

</script>

</body>
</html>
