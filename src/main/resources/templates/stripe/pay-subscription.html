<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{partials/head :: head('FremontMI - Businesses')}">
    <title>Subscription Payment</title>
</head>
<body>
<header th:insert="~{partials/navbar}"></header>
<main>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <h1 class="display-4">Subscription Payment</h1>

                <!-- Loading state -->
                <div id="loading-message" class="text-center my-4">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Fetching subscription details...</p>
                </div>

                <!-- Payment info will be shown here after loading -->
                <div id="payment-info" style="display:none;">
                    <p class="mb-2">You are paying for a <strong id="displayName"></strong> at <strong id="displayPrice"></strong>.</p>
<!--                    <p><a href="/create/business/overview" class="btn btn-link fw-semibold fs-sm p-0">Change Subscription</a></p>-->
                    <form id="payment-form" class="my-4">
                        <div id="payment-element"></div>
                        <div id="error-message" class="alert alert-danger mt-3" role="alert" style="display:none;"></div>
                        <button id="submit-button" class="btn btn-primary mt-4" type="submit" disabled>Submit Payment</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</main>

<script src="https://js.stripe.com/v3/"></script>
<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const contentId = urlParams.get('contentId');
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        const csrfHeader = document.querySelector('meta[name="csrf-header"]').getAttribute('content');

        // Fetch content information using the contentId
        try {
            const response = await fetch(`/api/get-content/${contentId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    [csrfHeader]: csrfToken,
                }
            });

            if (response.ok) {
                const data = await response.json();

                document.getElementById('displayName').textContent = data.displayName;
                document.getElementById('displayPrice').textContent = data.displayPrice;

                const stripe = Stripe("pk_test_51KCrhcBCHBXtJFxOMYJo8xRymfT9m3PvrruBp7gZmcvCV2vpYnMH8EdkwVeibCrtj5bwNhhuAj5MzWU1NXtq6iBs000IzgImdE");
                const elements = stripe.elements({ clientSecret: data.clientSecret });
                const paymentElement = elements.create("payment");
                paymentElement.mount("#payment-element");

                document.getElementById('payment-info').style.display = 'block';
                document.getElementById('loading-message').style.display = 'none';
                document.getElementById('submit-button').disabled = false;

                document.getElementById('payment-form').addEventListener('submit', async (event) => {
                    event.preventDefault();
                    document.getElementById('submit-button').disabled = true;

                    const {error: submitError} = await elements.submit();

                    if (submitError) {
                        document.getElementById('error-message').innerText = submitError.message;
                        document.getElementById('error-message').style.display = 'block';
                        document.getElementById('submit-button').disabled = false;
                        return;
                    }

                    const {error, paymentIntent} = await stripe.confirmPayment({
                        clientSecret: data.clientSecret,
                        elements,
                        confirmParams: {
                            return_url: "http://localhost:8080/payment-success",
                        },
                        redirect: "if_required"
                    });

                    if (paymentIntent.error) {
                        document.getElementById('error-message').innerText = error.message;
                        document.getElementById('error-message').style.display = 'block';
                        document.getElementById('submit-button').disabled = false;
                    } else {
                        await sendPaymentStatusToServer(paymentIntent, contentId);
                    }
                });

            } else {
                document.getElementById('error-message').innerText = 'Failed to load subscription details. Please try again later.';
                document.getElementById('error-message').style.display = 'block';
                document.getElementById('loading-message').style.display = 'none';
            }
        } catch (error) {
            document.getElementById('error-message').innerText = 'Error fetching subscription details. Please try again.';
            document.getElementById('error-message').style.display = 'block';
            document.getElementById('loading-message').style.display = 'none';
        }
    });

    async function sendPaymentStatusToServer(paymentIntent, contentId) {
        try {
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            const csrfHeader = document.querySelector('meta[name="csrf-header"]').getAttribute('content');
            let response = await fetch("/subscription-payment-success", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    [csrfHeader]: csrfToken,
                },
                body: JSON.stringify({
                    entityId: contentId,
                    paymentIntentId: paymentIntent.id,
                    paymentStatus: paymentIntent.status,
                }),
            });

            if (response.ok) {
                const { redirectUrl } = await response.json();
                window.location.href = redirectUrl;
            } else {
                document.getElementById("error-message").innerText = "Payment was successful, but there was an error updating your subscription. Please contact support.";
                document.getElementById("error-message").style.display = 'block';
            }
        } catch (error) {
            document.getElementById("error-message").innerText = "There was an issue processing your payment. Please try again.";
            document.getElementById("error-message").style.display = 'block';
        } finally {
            document.getElementById('submit-button').disabled = false;
        }
    }
</script>

<footer th:replace="~{partials/footer}"></footer>
</body>
</html>
