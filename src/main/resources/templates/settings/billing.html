<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{partials/head :: head('FremontMI - My Billing Info')}"><title>Placeholder Title</title></head>
<body class="bg-secondary">
<header th:insert="~{partials/navbar}"></header>

<div class="container mt-4">
    <h1 class="display-4">My Settings</h1>

    <ul class="nav nav-tabs" role="tablist">
        <li class="nav-item">
            <a href="/my/settings" class="nav-link" role="tab">
                Profile
            </a>
        </li>
        <li class="nav-item">
            <a href="/my/settings/billing" class="nav-link active" role="tab">
                Billing
            </a>
        </li>
    </ul>

    <section class="card border-0 py-1 p-md-2 p-xl-3 p-xxl-4 mb-4">
        <div class="card-body">
            <div class="d-flex align-items-center mt-sm-n1 mb-0 mb-lg-1 mb-xl-3">
                <i class="ai-wallet text-primary lead pe-1 me-2"></i>
                <h2 class="h4 mb-0">Billing</h2>
            </div>

            <h3 class="mt-4">Subscriptions</h3>
            <div id="subscriptions" class="row row-cols-1 row-cols-md-2 g-4">
            </div>

            <h3 class="mt-4">History</h3>
            <div id="invoices"></div>
        </div>
    </section>
</div>

<!--Manage Automatic Payments-->
<!--Allow users to toggle whether or not they want automatic payments enabled (Stripe supports this via the cancel_at_period_end property).-->

<script>
    document.addEventListener('DOMContentLoaded', async () => {
        // Fetch the list of subscriptions for this customer.
        const response = await fetch('/api/stripe/subscriptions').then((r) => r.json());

        // Construct and display each subscription, its status, and the current period end.
        const subscriptionsDiv = document.querySelector('#subscriptions');
        subscriptionsDiv.innerHTML = response.map((subscription) => {
            // Since you don't have a `last4` field, we will display the payment method type instead.
            let paymentMethod = subscription.paymentMethods.length > 0 ? subscription.paymentMethods[0] : 'N/A';

            // Use status to determine badge class
            let statusBadgeClass = subscription.status === 'active' ? 'bg-success' : (subscription.status === 'incomplete' ? 'bg-warning' : 'bg-danger');

            return `
        <div class="col">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title">Subscription ID: ${subscription.id}</h5>
                    <span class="badge ${statusBadgeClass}">${subscription.status}</span>
                    <p class="card-text mt-3">
                        <strong>Payment Method:</strong> ${paymentMethod}
                    </p>
                    <p class="card-text">
                        <strong>Current Period End:</strong> ${new Date(subscription.currentPeriodEnd * 1000).toLocaleDateString()}
                    </p>
                    <button class="btn btn-outline-danger cancel-subscription-btn" data-subscription-id="${subscription.id}">Cancel Subscription</button>
                </div>
                <div class="card-footer">
                    <small class="text-muted">Payment method displayed as type (e.g., card).</small>
                </div>
            </div>
        </div>
      `;
        }).join('');

        // Add event listeners to the cancel buttons
        const cancelButtons = document.querySelectorAll('.cancel-subscription-btn');
        cancelButtons.forEach(button => {
            button.addEventListener('click', async (event) => {
                const subscriptionId = event.target.getAttribute('data-subscription-id');
                const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
                const csrfHeader = document.querySelector('meta[name="csrf-header"]').getAttribute('content');

                // Send POST request to cancel the subscription
                const cancelResponse = await fetch('/api/stripe/cancel-subscription', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeader]: csrfToken,
                    },
                    body: JSON.stringify({ subscriptionId: subscriptionId })
                });

                if (cancelResponse.ok) {
                    alert('Subscription canceled successfully!');
                    // Optionally, refresh the page or remove the canceled subscription from the UI
                    location.reload();
                } else {
                    alert('Failed to cancel the subscription. Please try again.');
                }
            });
        });
    });
</script>


<script>
    document.addEventListener('DOMContentLoaded', async () => {
        // Fetch the list of invoices for this customer.
        const response = await fetch('/api/stripe/invoices').then((r) => r.json());

        const invoicesDiv = document.querySelector('#invoices');
        invoicesDiv.innerHTML = response.data.map((invoice) => {
            let statusBadgeClass = invoice.status === 'paid' ? 'bg-success' : (invoice.status === 'open' ? 'bg-warning' : 'bg-danger');
            let amount = (invoice.amount_due / 100).toFixed(2); // Convert from cents to dollars
            let date = new Date(invoice.created * 1000).toLocaleDateString();

            return `
        <div class="col">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title">Invoice ID: ${invoice.id}</h5>
                    <span class="badge ${statusBadgeClass}">${invoice.status}</span>
                    <p class="card-text mt-3">
                        <strong>Amount:</strong> $${amount}
                    </p>
                    <p class="card-text">
                        <strong>Date:</strong> ${date}
                    </p>
                    <a href="${invoice.hosted_invoice_url}" target="_blank" class="btn btn-outline-primary">View Invoice</a>
                </div>
            </div>
        </div>
      `;
        }).join('');
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', async () => {
        // Fetch the ID of the subscription from the query string
        // params.
        const params = new URLSearchParams(window.location.search);
        const subscriptionId = params.get('subscription');

        // When the cancel button is clicked, send an AJAX request
        // to our server to cancel the subscription.
        const cancelBtn = document.querySelector('#cancel-btn');
        cancelBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            setMessage("Cancelling subscription...");

            const {subscription} = await fetch('/api/stripe/cancel-subscription', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    subscriptionId
                }),
            })
                .then((response) => response.json())

            // Display the status of the subscription after attempting to
            // cancel.
            setMessage(`Subscription status: ${subscription.status}`);
            setMessage(`Redirecting back to account in 7s.`);


            // Redirect to the account page.
            setTimeout(() => {
                window.location.href = "account.html";
            }, 7 * 1000);
        });

        const setMessage = (message) => {
            const messagesDiv = document.querySelector('#messages');
            messagesDiv.innerHTML += "<br>" + message;
        }
    });

</script>

<script th:replace="~{partials/theme-js}"></script>
<footer th:replace="~{partials/footer}"></footer>
</body>
</html>



