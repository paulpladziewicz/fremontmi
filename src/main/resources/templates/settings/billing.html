<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{partials/head :: head('FremontMI - My Billing Info')}"><title>Placeholder Title</title></head>
<body class="bg-secondary">
<header th:insert="~{partials/navbar}"></header>

<div class="container mt-4">
    <h1 class="display-4">My Settings</h1>

    <ul class="nav nav-tabs" role="tablist">
        <li class="nav-item">
            <a href="/my/settings" class="nav-link" role="tab">
                Profile
            </a>
        </li>
        <li class="nav-item">
            <a href="/my/settings/billing" class="nav-link active" role="tab">
                Billing
            </a>
        </li>
    </ul>

    <section class="card border-0 py-1 p-md-2 p-xl-3 p-xxl-4 mb-4">
        <div class="card-body">
            <div class="d-flex align-items-center mt-sm-n1 mb-0 mb-lg-1 mb-xl-3">
                <i class="ai-wallet text-primary lead pe-1 me-2"></i>
                <h2 class="h4 mb-0">Billing</h2>
            </div>

            <h3 class="mt-4">Subscriptions</h3>
            <div id="subscriptions" class="row row-cols-1 row-cols-md-2 g-4">
            </div>

            <h3 class="mt-4">History</h3>
            <div id="invoices"></div>
        </div>
    </section>
</div>

<!--Manage Automatic Payments-->
<!--Allow users to toggle whether or not they want automatic payments enabled (Stripe supports this via the cancel_at_period_end property).-->

<script>
    document.addEventListener('DOMContentLoaded', async () => {
        // Fetch the list of subscriptions for this customer.
        const response = await fetch('/api/stripe/subscriptions').then((r) => r.json());

        const subscriptionsDiv = document.querySelector('#subscriptions');
        subscriptionsDiv.innerHTML = response.map((subscription) => {
            // Display the payment method type instead of last4.
            let paymentMethod = subscription.paymentMethods.length > 0 ? subscription.paymentMethods[0] : 'N/A';

            // Use status to determine badge class
            let statusBadgeClass = subscription.status === 'active'
                ? 'bg-success'
                : (subscription.status === 'incomplete'
                    ? 'bg-warning'
                    : 'bg-danger');

            // Check if the subscription is scheduled for cancellation at the end of the period
            const isCancelAtPeriodEnd = subscription.cancelAtPeriodEnd;

            // Determine the correct button (Cancel or Resume)
            let actionButton = '';
            if (isCancelAtPeriodEnd) {
                // Show "Resume Subscription" if it's set to cancel at the end
                actionButton = `
                    <button class="btn btn-outline-primary resume-subscription-btn" data-subscription-id="${subscription.id}">
                        Resume Subscription
                    </button>
                `;
            } else {
                // Show "Cancel Subscription" if it's not already set to cancel
                actionButton = `
                    <button class="btn btn-outline-danger cancel-subscription-btn" data-subscription-id="${subscription.id}">
                        Cancel Subscription
                    </button>
                `;
            }

            return `
        <div class="col">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title">Subscription ID: ${subscription.id}</h5>
                    <span class="badge ${statusBadgeClass}">${subscription.status}</span>
                    <p class="card-text mt-3">
                        <strong>Payment Method:</strong> ${paymentMethod}
                    </p>
                    <p class="card-text">
                        <strong>Current Period End:</strong> ${new Date(subscription.currentPeriodEnd * 1000).toLocaleDateString()}
                    </p>
                    ${actionButton}
                </div>
                <div class="card-footer">
                    <small class="text-muted">Payment method displayed as type (e.g., card).</small>
                </div>
            </div>
        </div>
      `;
        }).join('');

        // Add event listeners to the cancel and resume buttons
        document.querySelectorAll('.cancel-subscription-btn').forEach(button => {
            button.addEventListener('click', async (event) => {
                const subscriptionId = event.target.getAttribute('data-subscription-id');
                const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
                const csrfHeader = document.querySelector('meta[name="csrf-header"]').getAttribute('content');

                // Send POST request to cancel the subscription at the end of the period
                const cancelResponse = await fetch('/api/stripe/cancel-subscription', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeader]: csrfToken,
                    },
                    body: JSON.stringify({ subscriptionId: subscriptionId })
                });

                if (cancelResponse.ok) {
                    alert('Subscription scheduled to cancel at the end of the period!');
                    // Optionally, refresh the page or update the UI
                    location.reload();
                } else {
                    alert('Failed to schedule subscription cancellation. Please try again.');
                }
            });
        });

        // Add event listeners to the resume buttons
        document.querySelectorAll('.resume-subscription-btn').forEach(button => {
            button.addEventListener('click', async (event) => {
                const subscriptionId = event.target.getAttribute('data-subscription-id');
                const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
                const csrfHeader = document.querySelector('meta[name="csrf-header"]').getAttribute('content');

                // Send POST request to resume the subscription
                const resumeResponse = await fetch('/api/stripe/resume-subscription', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeader]: csrfToken,
                    },
                    body: JSON.stringify({ subscriptionId: subscriptionId })
                });

                if (resumeResponse.ok) {
                    alert('Subscription resumed successfully!');
                    // Optionally, refresh the page or update the UI
                    location.reload();
                } else {
                    alert('Failed to resume the subscription. Please try again.');
                }
            });
        });
    });
</script>


<script>
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            // Fetch the list of invoices for this customer.
            const response = await fetch('/api/stripe/invoices').then((r) => r.json());

            const invoicesDiv = document.querySelector('#invoices');

            // Check if the response is an array of invoices
            if (Array.isArray(response) && response.length > 0) {
                invoicesDiv.innerHTML = response.map((invoice) => {
                    let statusBadgeClass = invoice.status === 'paid'
                        ? 'bg-success'
                        : (invoice.status === 'open' ? 'bg-warning' : 'bg-danger');
                    let amount = (invoice.amountDue / 100).toFixed(2); // Convert from cents to dollars
                    let date = new Date(invoice.created * 1000).toLocaleDateString();

                    return `
                <div class="col">
                    <div class="card shadow-sm h-100">
                        <div class="card-body">
                            <h5 class="card-title">Invoice ID: ${invoice.id}</h5>
                            <span class="badge ${statusBadgeClass}">${invoice.status}</span>
                            <p class="card-text mt-3">
                                <strong>Amount:</strong> $${amount}
                            </p>
                            <p class="card-text">
                                <strong>Date:</strong> ${date}
                            </p>
                            ${invoice.paymentIntent ? `
                            <p class="card-text">
                                <strong>Payment Intent:</strong> ${invoice.paymentIntent}
                            </p>` : ''}
                            <a href="${invoice.hostedInvoiceUrl ? invoice.hostedInvoiceUrl : '#'}" target="_blank" class="btn btn-outline-primary">View Invoice</a>
                        </div>
                    </div>
                </div>
              `;
                }).join('');
            } else {
                invoicesDiv.innerHTML = '<p>No invoices found.</p>';
            }
        } catch (error) {
            console.error('Error fetching invoices:', error);
            const invoicesDiv = document.querySelector('#invoices');
            invoicesDiv.innerHTML = '<p>Error loading invoices. Please try again later.</p>';
        }
    });
</script>



<script th:replace="~{partials/theme-js}"></script>
<footer th:replace="~{partials/footer}"></footer>
</body>
</html>



