<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<head>
    <th:block th:insert="~{partials/layout :: sharedHead}"></th:block>
    <title>[[${group.detail.name}]] - Group in Fremont, MI</title>
    <meta name="description" th:content="${#strings.length(group.detail.description) > 160 ? #strings.substring(group.detail.description, 0, 157) + '...' : group.detail.description}" />
    <th:block th:if="${group.detail.tags != null and #lists.size(group.detail.tags) > 0}">
        <meta name="keywords" th:content="${#strings.arrayJoin(group.detail.tags, ', ')}" />
    </th:block>
</head>
<body>
<header th:insert="~{partials/navbar}"></header>

<main>
    <div class="container my-4">
        <div class="col-md-10 col-lg-8 mx-auto">
            <nav aria-label="breadcrumb">
                <ol class="pt-lg-3 pb-lg-4 pb-2 breadcrumb">
                    <li class="breadcrumb-item"><a href="/groups">Groups</a></li>
                    <li class="breadcrumb-item active" aria-current="page" th:text="${group.detail.name}"></li>
                </ol>
            </nav>
        </div>
        <div class="row">
            <div class="col-md-10 col-lg-8 mx-auto">
                <section>
                    <h1 class="display-4 mb-0" th:text="${group.detail.name}">Group Name</h1>
                    <p class="text-muted fw-semibold mt-3 mb-1">
                        <span th:text="${adminCount}"></span>
                        <span th:text="${adminCount == 1 ? 'Administrator' : 'Administrators'}"></span> -
                        <span th:text="${memberCount}"></span>
                        <span th:text="${memberCount == 1 ? 'Member' : 'Members'}"></span>
                    </p>
                    <section sec:authorize="!isAuthenticated()">
                        <p><a class="link-primary" href="/register">Register</a> or <a href="/login">Login</a> to join.</p>
                    </section>
                    <form sec:authorize="isAuthenticated()" th:if="${!isMember}" th:action="@{/groups/join}" method="post" onsubmit="disableSubmitButtonWhileSubmitting(this)">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <button type="submit" class="btn btn-link p-0">Join Group</button>
                    </form>
                    <form sec:authorize="isAuthenticated()" th:if="${isMember && !isAdmin}"
                          th:action="@{/groups/leave}" method="post" onsubmit="disableSubmitButtonWhileSubmitting(this)">
                        <button type="submit" class="btn btn-link p-0">Leave Group</button>
                    </form>
                    <p class="fs-lg my-3" th:utext="${group.detail.description}">Group description here...</p>
                </section>
                <section class="mb-4">
                    <div class="d-flex align-items-center mb-2">
                        <h2 class="h1 mb-0 me-2">Announcements</h2>
                        <button th:if="${isAdmin}" class="btn btn-outline-primary btn-sm py-1 px-2"
                                th:attr="hx-get='/announcements/group/form/' + ${group.id}"
                                hx-target="#add-announcement-form"
                                hx-swap="innerHTML"
                        >
                            Add
                        </button>
                    </div>
                    <div id="add-announcement-form"></div>
                    <ul id="announcementList" class="list-unstyled">
                        <li th:if="${group.detail.announcements.isEmpty()}">
                            <p class="my-3">
                                There are no announcements at this time.
                            </p>
                        </li>
                        <li class="my-4" th:each="announcement : ${group.detail.announcements}"
                            th:id="'announcement-' + ${announcement.id}">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="mb-1" th:text="${announcement.title}">Announcement Title</h5>
                                    <p class="mb-1" th:text="${announcement.content}">Announcement Content</p>
                                    <small class="text-muted" th:text="${announcement.getTimeAgo()}"></small>
                                </div>
                                <div th:if="${isAdmin}">
                                    <form onsubmit="disableSubmitButtonWhileSubmitting(this)" th:attr="hx-post='/delete/group/announcement', hx-swap='outerHTML', hx-target='#announcement-' + ${announcement.id}">
                                        <input type="hidden" th:name="${_csrf.parameterName}"
                                               th:value="${_csrf.token}"/>
                                        <input type="hidden" name="groupId" th:value="${group.id}"/>
                                        <input type="hidden" name="announcementId" th:value="${announcement.id}"/>
                                        <button type="submit" class="btn btn-danger btn-sm ms-4"><i class="ai-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </li>
                    </ul>
                </section>
                <div class="d-flex">
                    <div>
                        <a th:if="${isAdmin}" th:href="'/edit' + ${group.pathname}" class="btn btn-outline-primary me-2">Edit Group</a>

                    </div>
                    <a href="javascript:void(0);" id="emailAdministratorsLink" th:if="${!isAdmin && isMember}" type="button" class="btn btn-link p-0" onclick="openEmailForm('administrators')">Email Administrators</a>
                    <a href="javascript:void(0);" id="emailMembersLink" th:if="${isAdmin}" type="button" class="btn btn-link p-0" onclick="openEmailForm('members')">Email Members</a>                </div>
                <div id="emailGroupFormContainer" style="display: none; margin-top: 20px;">
                    <h5 id="emailGroupFormTitle">Email Group</h5>
                    <form id="emailGroupForm" onsubmit="sendEmailGroup(event)">
                        <div class="mb-3">
                            <label for="subject" class="form-label">Subject</label>
                            <input type="text" id="subject" name="subject" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="message" class="form-label">Message</label>
                            <textarea id="message" name="message" class="form-control" rows="5" required></textarea>
                        </div>
                        <input type="hidden" id="emailType" name="emailType"> <!-- Hidden input to distinguish email type -->
                        <div>
                            <button type="submit" class="btn btn-primary">Send Email</button>
                            <button type="button" class="btn btn-secondary" onclick="closeEmailForm()">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</main>

<script th:inline="javascript">
    // Function to open the email form
    function openEmailForm(emailType) {
        document.getElementById('emailGroupFormTitle').textContent = emailType === 'administrators' ? 'Email Administrators' : 'Email Members';
        document.getElementById('emailType').value = emailType;

        // Display the email form container
        const emailFormContainer = document.getElementById('emailGroupFormContainer');
        emailFormContainer.style.display = 'block';

        // Hide the email links when the form is open
        const emailAdministratorsLink = document.getElementById('emailAdministratorsLink');
        const emailMembersLink = document.getElementById('emailMembersLink');

        if (emailType === 'administrators' && emailAdministratorsLink) {
            emailAdministratorsLink.style.display = 'none';
        }

        if (emailType === 'members' && emailMembersLink) {
            emailMembersLink.style.display = 'none';
        }

        // Scroll to the form to make it visible within the document
        emailFormContainer.scrollIntoView({ behavior: 'smooth' });
    }

    // Function to close the email form
    function closeEmailForm() {
        document.getElementById('emailGroupFormContainer').style.display = 'none';
        document.getElementById('emailGroupForm').reset(); // Reset form fields

        // Show the email links when the form is closed
        const emailAdministratorsLink = document.getElementById('emailAdministratorsLink');
        const emailMembersLink = document.getElementById('emailMembersLink');

        if (emailAdministratorsLink) {
            emailAdministratorsLink.style.display = 'inline-flex';
        }

        if (emailMembersLink) {
            emailMembersLink.style.display = 'inline-flex';
        }
    }

    async function sendEmailGroup(event) {
        event.preventDefault(); // Prevent default form submission

        const form = document.getElementById('emailGroupForm');
        const formData = new FormData(form);

        const emailType = formData.get('emailType');

        // Create the JSON payload
        const payload = {
            subject: formData.get('subject'),
            message: formData.get('message')
        };

        // Replace the submit button with a loading state
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        submitButton.innerHTML = `
        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
        Sending emails...
    `;

        // Clear any existing messages
        const existingMessages = document.querySelectorAll('.email-response-message');
        existingMessages.forEach(msg => msg.remove());

        try {
            const response = await fetch('/email/group', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': /*[[${_csrf.token}]]*/ '' // CSRF token
                },
                body: JSON.stringify(payload)
            });

            if (response.ok) {
                // Close the email form
                closeEmailForm();

                // Display a success message
                const successMessage = document.createElement('p');
                successMessage.className = 'text-primary email-response-message mt-2';
                successMessage.textContent = 'Email(s) successfully sent.';
                document.getElementById('emailGroupFormContainer').parentNode.appendChild(successMessage);

                // Hide the email links after successful submission
                hideEmailLinks();
            } else {
                // Display an error message
                const errorMessageText = response.status === 400
                    ? 'You have reached the maximum number of emails you can send in one month, which is currently 5. Please contact us if you need to send more.'
                    : 'Failed to send email. Please try again.';

                const errorMessage = document.createElement('p');
                errorMessage.className = 'text-danger email-response-message mt-2';
                errorMessage.textContent = errorMessageText;
                document.getElementById('emailGroupFormContainer').parentNode.appendChild(errorMessage);
            }
        } catch (error) {
            console.error('Error sending email:', error);

            const errorMessage = document.createElement('p');
            errorMessage.className = 'text-danger email-response-message mt-2';
            errorMessage.textContent = 'An error occurred while sending the email. Please try again later.';
            document.getElementById('emailGroupFormContainer').parentNode.appendChild(errorMessage);
        } finally {
            // Revert the submit button back to its original state
            submitButton.disabled = false;
            submitButton.innerHTML = 'Send Email';
        }
    }

    function hideEmailLinks() {
        const emailAdministratorsLink = document.getElementById('emailAdministratorsLink');
        const emailMembersLink = document.getElementById('emailMembersLink');

        if (emailAdministratorsLink) {
            emailAdministratorsLink.style.display = 'none';
        }

        if (emailMembersLink) {
            emailMembersLink.style.display = 'none';
        }
    }
</script>



<footer th:replace="~{partials/footer}"></footer>
<script th:replace="~{partials/theme-js}"></script>


<script th:inline="javascript">
    window.onload = function () {
        const timeUntilLogout = (7 * 60 + 59) * 60 * 1000; // 7 hours 59 minutes

        setTimeout(function () {
            document.getElementById('logoutForm').submit();
        }, timeUntilLogout);
    };
</script>
</body>
</html>