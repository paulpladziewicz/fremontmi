<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{partials/head :: head('Create New Group')}">
    <title>Create Group</title>
</head>
<body>
<header th:replace="~{partials/navbar}"></header>

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-12 col-md-8 col-lg-6">
            <h1>Create New Group</h1>
            <p>Please only create groups that will organize in Fremont, MI. Content on this platform that does not relate to Fremont, Michigan can be removed at any time.</p>

            <form th:action="@{/create/group}" th:object="${group}" method="post" onsubmit="disableSubmitButtonWhileSubmitting(this)">

                <div class="form-group mb-2">
                    <label for="name" class="mb-1 form-label opacity-75 fw-medium fs-base">Group Name</label>
                    <input type="text" class="form-control" id="name" th:field="*{name}" placeholder="Enter group name" required>
                    <p th:if="${#fields.hasErrors('name')}" th:errors="*{name}" class="mt-1 text-danger"></p>
                </div>

                <div class="form-group mb-3">
                    <label for="description" class="mb-1 form-label opacity-75 fw-medium fs-base">Description</label>
                    <textarea class="form-control" id="description" th:field="*{description}" rows="3" placeholder="Group description" required></textarea>
                    <p th:if="${#fields.hasErrors('description')}" th:errors="*{description}" class="mt-1 text-danger"></p>
                </div>

<!--                <div th:replace="~{partials/tags-autocomplete-input}"></div>-->
                <div class="form-group position-relative">
                    <label for="tag-input">Tags</label>
                    <div class="input-group">
                        <input type="text" id="tag-input" name="tags" placeholder="Type tag" class="form-control" autocomplete="off" />
                        <button class="btn btn-primary" type="button" id="add-tag-button">Add</button>
                    </div>

                    <ul id="autocomplete-list" class="bg-light list-group w-100 position-absolute" style="top: 96px"></ul>

                    <small class="form-text text-muted">
                        Max 3 tags. Separate words allowed (e.g., "Ice Cream").
                        <a href="/tagging-guidelines" target="_blank">Learn how to tag well.</a>
                    </small>
                    <div id="tags-container" class="mt-2">
                        <!-- Tags will be displayed here -->
                    </div>
                    <input type="hidden" id="hidden-tag-input" name="tags">
                </div>

                <script>
                    document.addEventListener('DOMContentLoaded', function () {
                        const tagInput = document.getElementById('tag-input');
                        const addTagButton = document.getElementById('add-tag-button');
                        const tagsContainer = document.getElementById('tags-container');
                        const hiddenTagInput = document.getElementById('hidden-tag-input');
                        const autocompleteList = document.getElementById('autocomplete-list');
                        let tags = [];
                        let debounceTimeout;
                        const debounceDelay = 300;
                        const maxCharacters = 4;

                        // Event listener for the "Add" button
                        addTagButton.addEventListener('click', function () {
                            addTagFromInput();
                        });

                        // Event listener for pressing Enter in the input field
                        tagInput.addEventListener('keydown', function (e) {
                            if (e.key === 'Enter') {
                                e.preventDefault();  // Prevent form submission
                                addTagFromInput();
                            }
                        });

                        function addTagFromInput() {
                            const inputValue = tagInput.value.trim();
                            if (inputValue && !tags.includes(inputValue) && tags.length < 3) {
                                const formattedTag = formatTag(inputValue);
                                addTag(formattedTag);
                            }
                            tagInput.value = '';  // Clear input
                            hideAutocompleteSuggestions();
                        }

                        function formatTag(tag) {
                            return tag.split(' ').map(word => {
                                if (word.toUpperCase() === word) {
                                    return word;  // Acronym
                                } else {
                                    return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
                                }
                            }).join(' ');
                        }

                        function addTag(tag) {
                            tags.push(tag);

                            const tagPill = document.createElement('span');
                            tagPill.className = 'badge bg-primary bg-opacity-10 text-primary fs-sm me-1 mb-1';
                            tagPill.textContent = tag;

                            const removeButton = document.createElement('button');
                            removeButton.type = 'button';
                            removeButton.className = 'btn-close btn-close-white btn-sm ms-2';
                            removeButton.setAttribute('aria-label', 'Remove');
                            removeButton.addEventListener('click', function () {
                                removeTag(tag);
                            });
                            tagPill.appendChild(removeButton);

                            tagsContainer.appendChild(tagPill);
                            updateHiddenInput();

                            if (tags.length >= 3) {
                                tagInput.disabled = true;
                                addTagButton.disabled = true;
                            }
                        }

                        function removeTag(tag) {
                            tags = tags.filter(t => t !== tag);

                            const tagPills = tagsContainer.querySelectorAll('.badge');
                            tagPills.forEach(pill => {
                                if (pill.firstChild.textContent === tag) {
                                    pill.remove();
                                }
                            });

                            updateHiddenInput();

                            if (tags.length < 3) {
                                tagInput.disabled = false;
                                addTagButton.disabled = false;
                            }
                        }

                        function updateHiddenInput() {
                            hiddenTagInput.value = tags.join(',');
                        }

                        // Autocomplete with debouncing and API logic
                        tagInput.addEventListener('input', function () {
                            clearTimeout(debounceTimeout);
                            const query = tagInput.value.trim();

                            if (query.length >= 2 && query.length <= maxCharacters) {
                                debounceTimeout = setTimeout(() => {
                                    fetchAutocompleteSuggestions(query);
                                }, debounceDelay);
                            } else {
                                hideAutocompleteSuggestions();
                            }
                        });

                        function fetchAutocompleteSuggestions(query) {
                            const url = `/autocomplete/tags?query=${encodeURIComponent(query)}`;

                            fetch(url)
                                .then(response => response.json())
                                .then(suggestions => showAutocompleteSuggestions(suggestions))
                                .catch(error => console.error('Error fetching suggestions:', error));
                        }

                        function showAutocompleteSuggestions(suggestions) {
                            autocompleteList.innerHTML = '';
                            suggestions.forEach(suggestion => {
                                const item = document.createElement('li');
                                item.className = 'list-group-item list-group-item-action';
                                item.style.cursor = 'pointer';
                                item.textContent = suggestion;
                                item.addEventListener('click', function () {
                                    tagInput.value = suggestion;
                                    hideAutocompleteSuggestions();
                                    addTagFromInput();
                                });
                                autocompleteList.appendChild(item);
                            });
                            autocompleteList.style.display = 'block';
                        }

                        function hideAutocompleteSuggestions() {
                            autocompleteList.innerHTML = '';
                            autocompleteList.style.display = 'none';
                        }

                        document.addEventListener('click', function (e) {
                            if (!autocompleteList.contains(e.target) && e.target !== tagInput) {
                                hideAutocompleteSuggestions();
                            }
                        });
                    });
                </script>

                <button type="submit" class="btn btn-primary">Create Group</button>

            </form>
        </div>
    </div>
</div>

<script th:replace="~{partials/theme-js}"></script>
<footer th:replace="~{partials/footer}"></footer>

</body>
</html>